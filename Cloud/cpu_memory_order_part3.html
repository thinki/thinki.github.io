
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>CPU memory order: Part3 weak memory ordering · GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="cpu_memory_order_part4.html" />
    
    
    <link rel="prev" href="cpu_memory_order_part2.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    About Me
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="./">
            
                <a href="./">
            
                    
                    Cloud
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="How_qemu_kvm_manage_mem_part1.html">
            
                <a href="How_qemu_kvm_manage_mem_part1.html">
            
                    
                    How Qemu/KVM manage VM memory: Part1 system ram
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="How_qemu_kvm_manage_mem_part2.html">
            
                <a href="How_qemu_kvm_manage_mem_part2.html">
            
                    
                    How Qemu/KVM manage VM memory: Part2 mmio
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="linux_macvlan_and_nic_offload.html">
            
                <a href="linux_macvlan_and_nic_offload.html">
            
                    
                    Linux Macvlan and NIC offload
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4" data-path="switchdev_and_port_representor.html">
            
                <a href="switchdev_and_port_representor.html">
            
                    
                    Linux switchdev and DPDK port representor
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.5" data-path="cpu_memory_order_part1.html">
            
                <a href="cpu_memory_order_part1.html">
            
                    
                    CPU memory order: Part1 summary
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.6" data-path="cpu_memory_order_part2.html">
            
                <a href="cpu_memory_order_part2.html">
            
                    
                    CPU memory order: Part2 total store ordering 
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.2.7" data-path="cpu_memory_order_part3.html">
            
                <a href="cpu_memory_order_part3.html">
            
                    
                    CPU memory order: Part3 weak memory ordering
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.8" data-path="cpu_memory_order_part4.html">
            
                <a href="cpu_memory_order_part4.html">
            
                    
                    CPU memory order: Part4 memory barrier
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.9" data-path="Stateless_offload_uso_ufo.html">
            
                <a href="Stateless_offload_uso_ufo.html">
            
                    
                    Stateless offload: USO and UFO
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.10" data-path="dump_function_call.html">
            
                <a href="dump_function_call.html">
            
                    
                    Dump function call trace in linux kernel/user
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.11" data-path="lock_free_programming.html">
            
                <a href="lock_free_programming.html">
            
                    
                    Lock Free Programming
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.12" data-path="meson_build_for_local_lib.html">
            
                <a href="meson_build_for_local_lib.html">
            
                    
                    Meson build guide for local installed library
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../Archive/">
            
                <a href="../Archive/">
            
                    
                    网易博客存档
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="../Archive/fsl_imx6_ethernet_01.html">
            
                <a href="../Archive/fsl_imx6_ethernet_01.html">
            
                    
                    Freescale i.MX6 Linux Ethernet Driver驱动源码分析01
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="../Archive/fsl_imx6_ethernet_02.html">
            
                <a href="../Archive/fsl_imx6_ethernet_02.html">
            
                    
                    Freescale i.MX6 Linux Ethernet Driver驱动源码分析02
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="../Archive/linux_books.html">
            
                <a href="../Archive/linux_books.html">
            
                    
                    Linux Programming 经典书单
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >CPU memory order: Part3 weak memory ordering</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="cpu-memory-order-part3-weak-memory-ordering">CPU memory order: Part3 weak memory ordering</h1>
<p>As ARM follows weak memory ordering, all 4 types re-order is permitted. Below is a runtime detection refering to  <a href="https://preshing.com/20121019/this-is-why-they-call-it-a-weakly-ordered-cpu/" target="_blank">This Is Why They Call It a Weakly-Ordered CPU</a> </p>
<pre><code class="lang-shell">git clone https://github.com/preshing/AcquireRelease.git
{CROSS_COMPILE}-g++ main.cpp randomdelay.cpp -o test -lpthread -O2
</code></pre>
<p>assembly code below:</p>
<pre><code>0000000000001054 &lt;_Z33IncrementSharedValue10000000TimesR11RandomDelay&gt;:
    1054:&#x25B8;      a9bc7bfd &#x25B8;      stp&#x25B8;    x29, x30, [sp, #-64]!
    1058:&#x25B8;      910003fd &#x25B8;      mov&#x25B8;    x29, sp
    105c:&#x25B8;      a90153f3 &#x25B8;      stp&#x25B8;    x19, x20, [sp, #16]
    1060:&#x25B8;      b0000094 &#x25B8;      adrp&#x25B8;   x20, 12000 &lt;_ZSt9terminatev@GLIBCXX_3.4&gt;
    1064:&#x25B8;      91028294 &#x25B8;      add&#x25B8;    x20, x20, #0xa0
    1068:&#x25B8;      f9001bf7 &#x25B8;      str&#x25B8;    x23, [sp, #48]
    106c:&#x25B8;      5292d017 &#x25B8;      mov&#x25B8;    w23, #0x9680                &#x25B8;   // #38528
    1070:&#x25B8;      52800013 &#x25B8;      mov&#x25B8;    w19, #0x0                   &#x25B8;   // #0
    1074:&#x25B8;      72a01317 &#x25B8;      movk&#x25B8;   w23, #0x98, lsl #16
    1078:&#x25B8;      a9025bf5 &#x25B8;      stp&#x25B8;    x21, x22, [sp, #32]
    107c:&#x25B8;      aa0003f6 &#x25B8;      mov&#x25B8;    x22, x0
    1080:&#x25B8;      91004295 &#x25B8;      add&#x25B8;    x21, x20, #0x10
    1084:&#x25B8;      1400000c &#x25B8;      b&#x25B8;      10b4 &lt;_Z33IncrementSharedValue10000000TimesR11RandomDelay+0x60&gt;
    1088:&#x25B8;      94000056 &#x25B8;      bl&#x25B8;     11e0 &lt;_ZN11RandomDelay10doBusyWorkEv&gt;
    108c:&#x25B8;      aa1503e2 &#x25B8;      mov&#x25B8;    x2, x21
    1090:&#x25B8;      52800021 &#x25B8;      mov&#x25B8;    w1, #0x1                   &#x25B8;    // #1
    1094:&#x25B8;      52800000 &#x25B8;      mov&#x25B8;    w0, #0x0                   &#x25B8;    // #0
    1098:&#x25B8;      94000062 &#x25B8;      bl&#x25B8;     1220 &lt;__aarch64_cas4_acq&gt;
    109c:&#x25B8;      350000c0 &#x25B8;      cbnz&#x25B8;   w0, 10b4 &lt;_Z33IncrementSharedValue10000000TimesR11RandomDelay+0x60&gt;
    10a0:&#x25B8;      b9401681 &#x25B8;      ldr&#x25B8;    w1, [x20, #20]
    10a4:&#x25B8;      11000421 &#x25B8;      add&#x25B8;    w1, w1, #0x1
    10a8:&#x25B8;      b9001681 &#x25B8;      str&#x25B8;    w1, [x20, #20]
    10ac:&#x25B8;      889ffebf &#x25B8;      stlr&#x25B8;   wzr, [x21]
    10b0:&#x25B8;      11000673 &#x25B8;      add&#x25B8;    w19, w19, #0x1
    10b4:&#x25B8;      aa1603e0 &#x25B8;      mov&#x25B8;    x0, x22
    10b8:&#x25B8;      6b17027f &#x25B8;      cmp&#x25B8;    w19, w23
    10bc:&#x25B8;      54fffe61 &#x25B8;      b.ne&#x25B8;   1088 &lt;_Z33IncrementSharedValue10000000TimesR11RandomDelay+0x34&gt;  // b.any
    10c0:&#x25B8;      a94153f3 &#x25B8;      ldp&#x25B8;    x19, x20, [sp, #16]
    10c4:&#x25B8;      a9425bf5 &#x25B8;      ldp&#x25B8;    x21, x22, [sp, #32]
    10c8:&#x25B8;      f9401bf7 &#x25B8;      ldr&#x25B8;    x23, [sp, #48]
    10cc:&#x25B8;      a8c47bfd &#x25B8;      ldp&#x25B8;    x29, x30, [sp], #64
    10d0:&#x25B8;      d65f03c0 &#x25B8;      ret
    10d4:&#x25B8;      d503201f &#x25B8;      nop
    10d8:&#x25B8;      d503201f &#x25B8;      nop
</code></pre><p>make sure optimization level is <em>-O2</em> so that <strong>flag.store()</strong> just precedes <strong>count++</strong>. 
Below is comparison between Acquire/Release memory model and Relaxed memory model.
<img src="../images/cpu_memory_order_part3_01.png" alt="cpu_memory_order_part3_01"></p>
<p> In Acquire/Release memory model, re-order is forbidded after load acquire/before store release. So you can see that stlr is used to implement release semantics</p>
<pre><code>   10ac:    889ffebf     stlr    wzr, [x21]
</code></pre><p>In Relaxed memory model, no re-ordering is forbidded. So str is used</p>
<pre><code>    10ac:    b90002bf     str    wzr, [x21]
</code></pre><p><a href="https://developer.arm.com/documentation/100941/0100/Barriers" target="_blank">difference between stlr and str</a> is that:</p>
<p>A64 adds new load and store instructions with implicit barrier semantics. The instructions are less restrictive than either DMB or DSB instructions. They also require that all loads and stores before or after the implicit barrier are observed in program order.</p>
<p><strong>Load-Acquire (LDAR):</strong>All loads and stores that are after an LDAR in program order, and that match the shareability domain of the target address, must be observed after the LDAR.</p>
<p><strong>Store-Release (STLR):</strong>All loads and stores preceding an STLR that match the shareability domain of the target address must be observed before the STLR.</p>
<p>However ldr &amp; str doesn&apos;t have implicit barrier semantics, so re-order is allowed.</p>
<p>If we run this application on ARM Ares CPU, which supports out-of-order execution, re-order is detected as below:</p>
<pre><code class="lang-shell"># ./test
is_lock_free: true
sharedValue=19618777
sharedValue=19697796
sharedValue=19693566
sharedValue=19697246
sharedValue=19689454
sharedValue=19674865
sharedValue=19704563
sharedValue=19672579
sharedValue=19691453
sharedValue=19706577
sharedValue=19700628
sharedValue=19688644
sharedValue=19688454
sharedValue=19697910
sharedValue=19696821
sharedValue=19694087
sharedValue=19693936
sharedValue=19684349
sharedValue=19680494
sharedValue=19682880
sharedValue=19675949
sharedValue=19656381
sharedValue=19689995
sharedValue=19704096
</code></pre>
<p>If we run this applicaton on ARM Cortex-A53 CPU, which only supports in-order execution, re-order can&apos;t be detected as below:</p>
<pre><code class="lang-shell"># ./test
is_lock_free: true
sharedValue=20000000
sharedValue=20000000
sharedValue=20000000
sharedValue=20000000
sharedValue=20000000
sharedValue=20000000
sharedValue=20000000
sharedValue=20000000
sharedValue=20000000
sharedValue=20000000
sharedValue=20000000
sharedValue=20000000
sharedValue=20000000
sharedValue=20000000
sharedValue=20000000
sharedValue=20000000
sharedValue=20000000
sharedValue=20000000
sharedValue=20000000
sharedValue=20000000
sharedValue=20000000
sharedValue=20000000
sharedValue=20000000
sharedValue=20000000
sharedValue=20000000
sharedValue=20000000
sharedValue=20000000
sharedValue=20000000
sharedValue=20000000
sharedValue=20000000
sharedValue=20000000
sharedValue=20000000
sharedValue=20000000
sharedValue=20000000
</code></pre>
<p>This experiment proves that though ARM follows weak memory order, not all the arm cores is able to re-order Insturction and Memory, at least Cortex-A53(which only supports in-order execution) is not capable.</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="cpu_memory_order_part2.html" class="navigation navigation-prev " aria-label="Previous page: CPU memory order: Part2 total store ordering ">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="cpu_memory_order_part4.html" class="navigation navigation-next " aria-label="Next page: CPU memory order: Part4 memory barrier">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"CPU memory order: Part3 weak memory ordering","level":"1.2.7","depth":2,"next":{"title":"CPU memory order: Part4 memory barrier","level":"1.2.8","depth":2,"path":"Cloud/cpu_memory_order_part4.md","ref":"Cloud/cpu_memory_order_part4.md","articles":[]},"previous":{"title":"CPU memory order: Part2 total store ordering ","level":"1.2.6","depth":2,"path":"Cloud/cpu_memory_order_part2.md","ref":"Cloud/cpu_memory_order_part2.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":[],"pluginsConfig":{"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"Cloud/cpu_memory_order_part3.md","mtime":"2022-05-16T08:14:53.359Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2022-05-16T08:43:12.999Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

